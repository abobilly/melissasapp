<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melissa's Adventure - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: rgba(25, 25, 25, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            overflow-y: auto;
        }

        .chat-panel {
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #f0f0f0;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ffffff, #cccccc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 300;
        }

        h2 {
            color: #e0e0e0;
            margin-bottom: 20px;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            font-weight: 400;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(35, 35, 35, 0.6);
            border-radius: 6px;
            border-left: 3px solid #555;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #cccccc;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: rgba(40, 40, 40, 0.8);
            color: #e0e0e0;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        button {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px 10px 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-group input[type="range"] {
            flex: 1;
        }

        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        /* Chat Interface */
        .chat-history {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            background: white;
            margin-bottom: 15px;
            max-height: 400px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .user-message {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: #f0f0f0;
            color: #333;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input textarea {
            flex: 1;
            min-height: 80px;
            resize: vertical;
        }

        .chat-input button {
            align-self: flex-end;
            height: fit-content;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .quote-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .quote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
        }

        .quote-item button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 0;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <h1>üéÆ Melissa's Adventure Admin Panel</h1>
            
            <div class="section">
                <h2>üéØ Game Controls</h2>
                <div class="button-group">
                    <button onclick="applyAllChanges()">üíæ Apply All Changes</button>
                    <button onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
                    <button onclick="openGame()">üöÄ Open Game</button>
                    <button onclick="previewChanges()">üëÅÔ∏è Preview Changes</button>
                    <button onclick="refreshGameTab()">üîÑ Refresh Game</button>
                    <button onclick="generateConfigFile()">üìÑ Generate Config</button>
                    <button onclick="checkDevServer()">üîß Check Dev Server</button>
                </div>
                <div id="status"></div>
                <div id="gameTabStatus" class="status" style="display: none;"></div>
                
                <div class="section" style="background: rgba(255, 243, 205, 0.8); border-left-color: #f39c12;">
                    <h3>üöÄ Development Mode Setup</h3>
                    <p><strong>For REAL source code modification:</strong></p>
                    <ol>
                        <li>Open VS Code terminal in this folder</li>
                        <li>Run: <code>npm install</code></li>
                        <li>Run: <code>npm run dev</code></li>
                        <li>Now "Apply All Changes" will modify your actual HTML file!</li>
                    </ol>
                    <p><em>Without dev server: Changes only save to browser storage (temporary)</em></p>
                </div>
            </div>

            <div class="section">
                <h2>üë© Aunt Settings</h2>
                
                <div class="form-group">
                    <label>Aunt Movement Speed</label>
                    <div class="range-group">
                        <input type="range" id="auntSpeed" min="1" max="10" value="5">
                        <span class="range-value" id="auntSpeedValue">5</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Aunt Quote Frequency (seconds)</label>
                    <div class="range-group">
                        <input type="range" id="auntQuoteFreq" min="2" max="15" value="4">
                        <span class="range-value" id="auntQuoteFreqValue">4</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Shaking Duration (seconds)</label>
                    <div class="range-group">
                        <input type="range" id="shakingDuration" min="3" max="15" value="8">
                        <span class="range-value" id="shakingDurationValue">8</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Butterfly Attraction Range (pixels)</label>
                    <div class="range-group">
                        <input type="range" id="attractionRange" min="50" max="400" value="200">
                        <span class="range-value" id="attractionRangeValue">200</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cousin Repulsion Range (pixels)</label>
                    <div class="range-group">
                        <input type="range" id="repulsionRange" min="50" max="300" value="150">
                        <span class="range-value" id="repulsionRangeValue">150</span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="auntStopsWhenSpeaking" checked>
                        <label for="auntStopsWhenSpeaking">Aunt stops moving when speaking</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üë• Cousin Settings</h2>
                
                <div class="form-group">
                    <label>MLM Dialogue Frequency (%)</label>
                    <div class="range-group">
                        <input type="range" id="mlmFrequency" min="10" max="100" value="70">
                        <span class="range-value" id="mlmFrequencyValue">70</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cousin Quote Interval (seconds)</label>
                    <div class="range-group">
                        <input type="range" id="cousinQuoteInterval" min="2" max="12" value="5">
                        <span class="range-value" id="cousinQuoteIntervalValue">5</span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="hoverElimination" checked>
                        <label for="hoverElimination">Enable hover elimination</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="explosionEffect" checked>
                        <label for="explosionEffect">Show explosion on transformation</label>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ü¶ã Butterfly Settings</h2>
                
                <div class="form-group">
                    <label>Initial Butterfly Count</label>
                    <div class="range-group">
                        <input type="range" id="butterflyCount" min="5" max="30" value="15">
                        <span class="range-value" id="butterflyCountValue">15</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Butterfly Movement Chance (%)</label>
                    <div class="range-group">
                        <input type="range" id="butterflyMovement" min="10" max="80" value="30">
                        <span class="range-value" id="butterflyMovementValue">30</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üí¨ Quote Management</h2>
                
                <div class="form-group">
                    <label>Add New Aunt Quote</label>
                    <textarea id="newAuntQuote" placeholder="Enter new aunt quote..." rows="2"></textarea>
                    <button onclick="addAuntQuote()">Add Aunt Quote</button>
                </div>

                <div class="form-group">
                    <label>Add New Cousin Quote</label>
                    <textarea id="newCousinQuote" placeholder="Enter new cousin quote..." rows="2"></textarea>
                    <button onclick="addCousinQuote()">Add Cousin Quote</button>
                </div>

                <div class="form-group">
                    <label>Current Aunt Quotes</label>
                    <div id="auntQuotesList" class="quote-list"></div>
                </div>

                <div class="form-group">
                    <label>Current Cousin Quotes</label>
                    <div id="cousinQuotesList" class="quote-list"></div>
                </div>
            </div>

            <div class="section">
                <h2>üé® Visual Settings</h2>
                
                <div class="form-group">
                    <label>Speech Bubble Duration (seconds)</label>
                    <div class="range-group">
                        <input type="range" id="bubbleDuration" min="1" max="8" value="3">
                        <span class="range-value" id="bubbleDurationValue">3</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Background Image</label>
                    <select id="backgroundImage">
                        <option value="outdoors.webp">Outdoors Scene</option>
                        <option value="custom">Upload Custom (TODO)</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSparkles" checked>
                        <label for="showSparkles">Show ambient sparkles</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel chat-panel">
            <h2>üí¨ Chat with Assistant</h2>
            <div class="chat-history" id="chatHistory">
                <div class="chat-message ai-message">
                    <strong>Assistant:</strong> üéÆ <strong>Welcome to Melissa's Adventure Admin Panel!</strong><br><br>
                    
                    <strong>üìã How to Use:</strong><br>
                    1. Adjust settings using sliders and checkboxes<br>
                    2. Click "Apply All Changes" to save<br>
                    3. Click "Open Game" to test your changes<br>
                    4. Use "Refresh Game" to reload after changes<br><br>
                    
                    <strong>üíæ Important:</strong> This is a local admin panel. Settings save to your browser storage. For permanent changes, you'll need to modify the HTML file directly or use the "Generate Config" feature.<br><br>
                    
                    <strong>‚ùì Current Limitations:</strong><br>
                    ‚Ä¢ Chat is simulated (not real AI)<br>
                    ‚Ä¢ Changes don't auto-apply to game<br>
                    ‚Ä¢ Manual refresh needed after changes<br><br>
                    
                    Ask me about game mechanics, settings explanations, or troubleshooting!
                </div>
            </div>
            <div class="chat-input">
                <textarea id="chatInput" placeholder="Ask me about game changes, report issues, or get help..."></textarea>
                <button onclick="sendMessage()">Send</button>
            </div>
            <div class="button-group">
                <button onclick="clearChat()">Clear Chat</button>
                <button onclick="exportChat()">Export Chat</button>
            </div>
        </div>
    </div>

    <script>
        // Game configuration object
        let gameConfig = {
            auntSpeed: 5,
            auntQuoteFreq: 4,
            shakingDuration: 8,
            attractionRange: 200,
            repulsionRange: 150,
            auntStopsWhenSpeaking: true,
            mlmFrequency: 70,
            cousinQuoteInterval: 5,
            hoverElimination: true,
            explosionEffect: true,
            butterflyCount: 15,
            butterflyMovement: 30,
            bubbleDuration: 3,
            backgroundImage: 'outdoors.webp',
            showSparkles: true,
            auntQuotes: [
                "I'm the queen bee! üëë",
                "I'm just being authentic!",
                "I'm shaking. I'm physically shaking.",
                "You're dismissed",
                "Hi, Baby Gorgeous!"
            ],
            cousinQuotes: [
                "I had to fire 30 employees.",
                "The launch is cancelled.",
                "I am more of a free spirit without the Holy Spirit",
                "On my healing journey, I always travel first class",
                "Stop weaponizing my trauma against me",
                "I would never assume that Meredith has a dirty house",
                "This rose isn't scared to handle a little prick",
                "There's more bathtub fights coming",
                "Have you heard of s≈çl?",
                "Join my MLM!"
            ]
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigToUI();
            setupRangeListeners();
            loadQuoteLists();
            loadChatHistory();
        });

        function setupRangeListeners() {
            const ranges = ['auntSpeed', 'auntQuoteFreq', 'shakingDuration', 'attractionRange', 'repulsionRange', 
                          'mlmFrequency', 'cousinQuoteInterval', 'butterflyCount', 'butterflyMovement', 'bubbleDuration'];
            
            ranges.forEach(id => {
                const range = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');
                
                range.addEventListener('input', function() {
                    valueSpan.textContent = this.value;
                    gameConfig[id] = parseInt(this.value);
                });
            });
        }

        function loadConfigToUI() {
            // Load all range values
            Object.keys(gameConfig).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'range') {
                        element.value = gameConfig[key];
                        const valueSpan = document.getElementById(key + 'Value');
                        if (valueSpan) valueSpan.textContent = gameConfig[key];
                    } else if (element.type === 'checkbox') {
                        element.checked = gameConfig[key];
                    } else if (element.tagName === 'SELECT') {
                        element.value = gameConfig[key];
                    }
                }
            });
        }

        function loadQuoteLists() {
            loadAuntQuotes();
            loadCousinQuotes();
        }

        function loadAuntQuotes() {
            const container = document.getElementById('auntQuotesList');
            container.innerHTML = '';
            gameConfig.auntQuotes.forEach((quote, index) => {
                const item = document.createElement('div');
                item.className = 'quote-item';
                item.innerHTML = `
                    <span>"${quote}"</span>
                    <button onclick="removeAuntQuote(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function loadCousinQuotes() {
            const container = document.getElementById('cousinQuotesList');
            container.innerHTML = '';
            gameConfig.cousinQuotes.forEach((quote, index) => {
                const item = document.createElement('div');
                item.className = 'quote-item';
                item.innerHTML = `
                    <span>"${quote}"</span>
                    <button onclick="removeCousinQuote(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function addAuntQuote() {
            const input = document.getElementById('newAuntQuote');
            const quote = input.value.trim();
            
            if (quote) {
                gameConfig.auntQuotes.push(quote);
                input.value = '';
                loadAuntQuotes();
                showStatus('Aunt quote added successfully!', 'success');
            }
        }

        function addCousinQuote() {
            const input = document.getElementById('newCousinQuote');
            const quote = input.value.trim();
            
            if (quote) {
                gameConfig.cousinQuotes.push(quote);
                input.value = '';
                loadCousinQuotes();
                showStatus('Cousin quote added successfully!', 'success');
            }
        }

        function removeAuntQuote(index) {
            gameConfig.auntQuotes.splice(index, 1);
            loadAuntQuotes();
            showStatus('Aunt quote removed!', 'success');
        }

        function removeCousinQuote(index) {
            gameConfig.cousinQuotes.splice(index, 1);
            loadCousinQuotes();
            showStatus('Cousin quote removed!', 'success');
        }

        async function applyAllChanges() {
            // Update config from UI
            updateConfigFromUI();
            
            showStatus('Applying changes...', 'success');
            
            try {
                // Try to update the actual source code
                const response = await fetch('http://localhost:3002/api/update-game-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(gameConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('üéâ Source code updated successfully! Changes are now permanent.', 'success');
                    
                    // Also update quotes
                    const quotesResponse = await fetch('http://localhost:3002/api/update-quotes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(gameConfig)
                    });

                    if (quotesResponse.ok) {
                        showStatus('‚úÖ All changes applied to source code! Game windows will auto-refresh.', 'success');
                        
                        // Trigger auto-refresh of game windows
                        triggerGameRefresh();
                    }
                    
                    addToChatHistory('User', 'Applied all configuration changes to source code');
                    addToChatHistory('Assistant', 'üéâ Excellent! Your changes have been written directly to butterfly-waterfall.html! The modifications are now permanent and game windows will automatically refresh to show the new changes.');
                } else {
                    throw new Error('Server response not OK');
                }
            } catch (error) {
                console.warn('Development server not available, falling back to local storage', error);
                
                // Fallback to localStorage
                localStorage.setItem('melissaGameConfig', JSON.stringify(gameConfig));
                showStatus('‚ö†Ô∏è Changes saved locally only. Start dev server for permanent changes.', 'error');
                
                addToChatHistory('User', 'Applied all configuration changes (local only)');
                addToChatHistory('Assistant', '‚ö†Ô∏è Changes saved to browser storage only. To make permanent changes to your source code:<br><br>1. Run `npm install` in VS Code terminal<br>2. Run `npm run dev` to start the development server<br>3. Then use "Apply All Changes" to modify the actual HTML file!');
            }
        }

        function updateConfigFromUI() {
            // Update checkboxes
            gameConfig.auntStopsWhenSpeaking = document.getElementById('auntStopsWhenSpeaking').checked;
            gameConfig.hoverElimination = document.getElementById('hoverElimination').checked;
            gameConfig.explosionEffect = document.getElementById('explosionEffect').checked;
            gameConfig.showSparkles = document.getElementById('showSparkles').checked;
            
            // Update select
            gameConfig.backgroundImage = document.getElementById('backgroundImage').value;
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                // Reset to original config
                gameConfig = {
                    auntSpeed: 5,
                    auntQuoteFreq: 4,
                    shakingDuration: 8,
                    attractionRange: 200,
                    repulsionRange: 150,
                    auntStopsWhenSpeaking: true,
                    mlmFrequency: 70,
                    cousinQuoteInterval: 5,
                    hoverElimination: true,
                    explosionEffect: true,
                    butterflyCount: 15,
                    butterflyMovement: 30,
                    bubbleDuration: 3,
                    backgroundImage: 'outdoors.webp',
                    showSparkles: true,
                    auntQuotes: [
                        "I'm the queen bee! üëë",
                        "I'm just being authentic!",
                        "I'm shaking. I'm physically shaking.",
                        "You're dismissed",
                        "Hi, Baby Gorgeous!"
                    ],
                    cousinQuotes: [
                        "I had to fire 30 employees.",
                        "The launch is cancelled.",
                        "I am more of a free spirit without the Holy Spirit",
                        "On my healing journey, I always travel first class",
                        "Stop weaponizing my trauma against me",
                        "I would never assume that Meredith has a dirty house",
                        "This rose isn't scared to handle a little prick",
                        "There's more bathtub fights coming",
                        "Have you heard of s≈çl?",
                        "Join my MLM!"
                    ]
                };
                
                loadConfigToUI();
                loadQuoteLists();
                showStatus('Settings reset to defaults!', 'success');
            }
        }

        let gameWindow = null;

        function openGame() {
            gameWindow = window.open('butterfly-waterfall.html', '_blank');
            
            if (gameWindow) {
                showGameTabStatus('Game opened in new tab! üéÆ', 'success');
                
                // Check if game tab is still open periodically
                const checkInterval = setInterval(() => {
                    if (gameWindow.closed) {
                        showGameTabStatus('Game tab was closed', 'error');
                        clearInterval(checkInterval);
                        gameWindow = null;
                    }
                }, 2000);
            } else {
                showGameTabStatus('Could not open game tab. Please allow popups!', 'error');
            }
        }

        function refreshGameTab() {
            if (gameWindow && !gameWindow.closed) {
                gameWindow.location.reload();
                showGameTabStatus('Game tab refreshed! üîÑ', 'success');
            } else {
                showGameTabStatus('No game tab open. Open game first!', 'error');
            }
        }

        function showGameTabStatus(message, type) {
            const statusDiv = document.getElementById('gameTabStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 4000);
        }

        function triggerGameRefresh() {
            // Use localStorage to signal game windows to refresh
            const timestamp = Date.now();
            localStorage.setItem('gameRefreshTrigger', timestamp.toString());
            
            // Also use BroadcastChannel API for modern browsers
            if (window.BroadcastChannel) {
                const channel = new BroadcastChannel('game-updates');
                channel.postMessage({
                    type: 'refresh',
                    timestamp: timestamp
                });
                channel.close();
            }
            
            // Try to find and refresh any game windows
            try {
                // This will work if the game window was opened from this window
                if (window.gameWindow && !window.gameWindow.closed) {
                    window.gameWindow.location.reload();
                }
            } catch (e) {
                // Cross-origin restrictions prevent direct access
                console.log('Using localStorage/BroadcastChannel for cross-window communication');
            }
        }

        async function checkDevServer() {
            try {
                const response = await fetch('http://localhost:3002/api/health');
                if (response.ok) {
                    const result = await response.json();
                    showStatus('‚úÖ Development server is running! You can make permanent changes.', 'success');
                    addToChatHistory('System', 'Development server status: ONLINE ‚úÖ');
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                showStatus('‚ùå Development server not running. Start with: npm run dev', 'error');
                addToChatHistory('System', 'Development server status: OFFLINE ‚ùå<br>Run these commands in VS Code terminal:<br>1. npm install<br>2. npm run dev');
            }
        }

        function generateConfigFile() {
            updateConfigFromUI();
            
            const configJS = `
// Auto-generated configuration for Melissa's Adventure
// Generated on: ${new Date().toLocaleString()}

const GAME_CONFIG = ${JSON.stringify(gameConfig, null, 2)};

// Apply configuration to game
if (typeof applyGameConfig === 'function') {
    applyGameConfig(GAME_CONFIG);
}
`;
            
            const blob = new Blob([configJS], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'melissa-game-config.js';
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('Configuration file generated! Add it to your HTML.', 'success');
        }

        function previewChanges() {
            updateConfigFromUI();
            const changes = Object.keys(gameConfig).map(key => `${key}: ${gameConfig[key]}`).join('\n');
            alert('Current Configuration:\n\n' + changes);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addToChatHistory('User', message);
                input.value = '';
                
                // Simulate AI response (in a real implementation, this would call an API)
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addToChatHistory('Assistant', response);
                }, 1000);
            }
        }

        function addToChatHistory(sender, message) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender.toLowerCase()}-message`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Save to localStorage
            saveChatHistory();
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('how') && (message.includes('use') || message.includes('work'))) {
                return "üîß <strong>How to Use This Admin Panel:</strong><br><br>1. <strong>Make Changes:</strong> Use sliders, checkboxes, and text inputs<br>2. <strong>Apply Changes:</strong> Click 'Apply All Changes' to save<br>3. <strong>Test Game:</strong> Click 'Open Game' to open in new tab<br>4. <strong>Refresh:</strong> Use 'Refresh Game' after making changes<br><br><strong>üí° Pro Tip:</strong> The game needs to be refreshed to see your changes!";
            } else if (message.includes('save') || message.includes('permanent')) {
                return "üíæ <strong>Saving Your Changes:</strong><br><br><strong>Current System:</strong> Settings save to browser localStorage (temporary)<br><br><strong>For Permanent Changes:</strong><br>1. Use 'Generate Config' to download a config file<br>2. Edit the HTML file directly in VS Code<br>3. Commit changes to Git<br><br><strong>‚ö†Ô∏è Note:</strong> Browser storage will reset if you clear browser data!";
            } else if (message.includes('chat') || message.includes('real') || message.includes('connect')) {
                return "üí¨ <strong>About This Chat:</strong><br><br><strong>Current:</strong> This is a simulated chat with pre-programmed responses<br><br><strong>For Real Help:</strong><br>‚Ä¢ Ask questions in VS Code with GitHub Copilot<br>‚Ä¢ Create GitHub issues for bugs<br>‚Ä¢ Use the VS Code chat for live assistance<br><br>This chat is mainly for understanding how settings work!";
            } else if (message.includes('refresh') || message.includes('update')) {
                return "üîÑ <strong>Refreshing & Updates:</strong><br><br><strong>After Making Changes:</strong><br>1. Click 'Apply All Changes'<br>2. Click 'Refresh Game' (if game tab is open)<br>3. Or close and reopen the game<br><br><strong>Auto-refresh:</strong> Not currently supported - manual refresh needed<br><br>The game tab status will show if refresh worked!";
            } else if (message.includes('aunt') && message.includes('speed')) {
                return "üë© <strong>Aunt Movement Speed:</strong><br><br>‚Ä¢ <strong>1-3:</strong> Very slow, rarely moves<br>‚Ä¢ <strong>4-6:</strong> Normal movement (default: 5)<br>‚Ä¢ <strong>7-10:</strong> Very active, moves frequently<br><br>She also stops moving when speaking if that option is enabled!";
            } else if (message.includes('cousin') && (message.includes('mlm') || message.includes('sol'))) {
                return "üë• <strong>Cousin MLM Settings:</strong><br><br>‚Ä¢ <strong>MLM Frequency:</strong> % chance they mention s≈çl/MLM<br>‚Ä¢ <strong>Quote Interval:</strong> How often they speak<br>‚Ä¢ <strong>Current:</strong> 70% chance every 5 seconds<br><br>Higher frequency = more MLM spam! üìàüí∏";
            } else if (message.includes('quote')) {
                return "üí¨ <strong>Quote Management:</strong><br><br>‚Ä¢ <strong>Add:</strong> Type new quote, click Add button<br>‚Ä¢ <strong>Remove:</strong> Click Remove next to existing quotes<br>‚Ä¢ <strong>Apply:</strong> Changes take effect when you apply settings<br><br>You can customize all dialogue this way!";
            } else if (message.includes('browser') || message.includes('vscode')) {
                return "üåê <strong>Browser vs VS Code:</strong><br><br><strong>Browser:</strong> Admin panel works in any browser<br><strong>VS Code:</strong> Edit HTML files directly<br><br><strong>Workflow:</strong><br>1. Use admin panel for quick testing<br>2. Use VS Code for permanent changes<br>3. Commit to Git for version control<br><br>Both approaches work together!";
            } else if (message.includes('help')) {
                return "‚ùì <strong>Available Help Topics:</strong><br><br>‚Ä¢ <strong>'how to use'</strong> - Usage instructions<br>‚Ä¢ <strong>'save permanent'</strong> - Making lasting changes<br>‚Ä¢ <strong>'chat real'</strong> - About this chat system<br>‚Ä¢ <strong>'refresh update'</strong> - How to update game<br>‚Ä¢ <strong>'aunt speed'</strong> - Movement settings<br>‚Ä¢ <strong>'cousin MLM'</strong> - Dialogue settings<br>‚Ä¢ <strong>'browser vs vscode'</strong> - Workflow tips<br><br>What would you like to know about?";
            } else {
                return "ü§ñ I'm here to help explain the admin panel! Try asking:<br><br>‚Ä¢ <strong>'How do I use this?'</strong><br>‚Ä¢ <strong>'How do I save changes permanently?'</strong><br>‚Ä¢ <strong>'How does the chat work?'</strong><br>‚Ä¢ <strong>'How do I refresh the game?'</strong><br><br>Or ask about specific settings like aunt speed, cousin quotes, etc.!";
            }
        }

        function clearChat() {
            if (confirm('Clear all chat history?')) {
                document.getElementById('chatHistory').innerHTML = `
                    <div class="chat-message ai-message">
                        <strong>Assistant:</strong> Hi! I'm here to help you customize Melissa's Adventure. You can ask me about any changes you'd like to make, report issues, or get explanations about the game mechanics. What would you like to work on?
                    </div>
                `;
                localStorage.removeItem('melissaChatHistory');
            }
        }

        function exportChat() {
            const chatHistory = document.getElementById('chatHistory');
            const messages = Array.from(chatHistory.children).map(div => div.textContent).join('\n\n');
            
            const blob = new Blob([messages], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'melissa-adventure-chat-' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            localStorage.setItem('melissaChatHistory', chatHistory.innerHTML);
        }

        function loadChatHistory() {
            const saved = localStorage.getItem('melissaChatHistory');
            if (saved) {
                document.getElementById('chatHistory').innerHTML = saved;
            }
        }

        // Handle Enter key in chat
        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendMessage();
            }
        });
    </script>
</body>
</html>